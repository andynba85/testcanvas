<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    
    <!--google font-->
    <link href="https://fonts.googleapis.com/css?family=Lacquer|Roboto|Source+Sans+Pro|Squada+One|Sriracha&display=swap" rel="stylesheet">

    <!--調色盤-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/> <!-- 'classic' theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/monolith.min.css"/> <!-- 'monolith' theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css"/> <!-- 'nano' theme -->
    <!-- Modern or es5 bundle -->
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.es5.min.js"></script>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      .container{
        border-style: solid;
        border-radius: 5px;
        border-color: #eeeeee;
        padding: 10px 20px 2px 20px;
      }
      #show{
        border-style: solid;
        border-radius: 5px;
        border-color: #eeeeee;
        padding: 10px 20px 2px 20px;
        display: none;
      }
      #canvas{
        border-color: #eeeeee;
      }
      .toolbar{
        background-color: black;
        margin: 10px 10px 10px 10px;
      }
      .img_preview{

      }
      img {
        display: inline-block;
        border: 1px solid #eaeaea;
        height: 100px;
        width: 100px;

      }

      #file2{
        display: none;
      }
      .temp{
        display: none;
        height: 100px;
        background-color: yellow; 
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div>
        <h5 class="center">Daily</h5>
      </div>
      <div class="row">
        <form class="col s12">  
            <div class="input-field col s6">
              <i class="material-icons prefix">assignment</i>
              <input id="topic" type="text" class="validate">
              <label for="topic">請輸入標題</label>
            </div>
            <div class="input-field col s6">
              <i class="material-icons prefix">date_range</i>
              <input id="date" type="text" class="datepicker">
              <label for="date">請輸入日期</label>
            </div>
            <div class="input-field col s12">
              <i class="material-icons prefix">edit</i>
              <textarea id="textarea1" type="text" class="materialize-textarea"></textarea>
              <label for="textarea1">寫點內容吧</label>
            </div>
        </form> 
      </div>

      <div class="row">
        <form action="#">
          <div class="file-field input-field">
            <div class="btn">
              <span>File</span>
              <input type="file" id="file" multiple>
            </div>
            <div class="file-path-wrapper">
              <input class="file-path validate" type="text" placeholder="Upload one or more files">
            </div>
          </div>
        </form>
      </div>
      <div class="center">
        <button class="btn waves-effect waves-light center" type="submit" name="action" onclick="send_daily();">Submit
          <i class="material-icons right">send</i>
        </button>  
      </div>
      

      <div id="show" class="container"><div id="result"></div></div>

    </div>

    
    <div class="row toolbar">
      <a class="btn-floating btn-large waves-effect waves-light red" id="edit_text"><i class="material-icons">edit</i></a>
      <a class="btn-floating btn-large waves-effect waves-light red" id="edit_effect"><i class="material-icons">add</i></a>
      <a class="btn-floating btn-large waves-effect waves-light red" id="change_background"><i class="material-icons">panorama</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="moveup"><i class="material-icons">arrow_upward</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="movedown"><i class="material-icons">arrow_downward</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="deleteobj"><i class="material-icons">delete</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="undo"><i class="material-icons">navigate_before</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="redo"><i class="material-icons">navigate_next</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="font_bold"><i class="material-icons">format_bold</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="font_color"><i class="material-icons">format_color_text</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="font_italic"><i class="material-icons">format_italic</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red modal-trigger" href="#font_type">
      <i class="material-icons">font_download</i></a>
      <a class="btn-floating btn-small waves-effect waves-light red" id="file_download"><i class="material-icons">file_download</i></a>
      <div class="btn" id="imageUploader">
        <span>Upload</span>
        <i class="material-icons">add_a_photo</i>
        <input type="file" id="file2" multiple>
      </div>
      <div id="imgset">
        <img id="defaultImg" src="https://www.pakutaso.com/shared/img/thumb/neko1869IMG_9074_TP_V.jpg">
      </div>     
    </div>

    <div class="temp" id="tempcolumn">
      <img id="bg-1" src="bg-1.jpg">
      <img id="bg-2" src="bg-2.jpg">
      <img id="bg-3" src="bg-3.jpg">
      <img id="bg-4" src="bg-4.jpg">
      <img id="bg-5" src="bg-5.jpg">
      <img id="bg-6" src="bg-6.jpg">
    </div>
    <div class="temp" id="temppaste">
      <img id="paste-circle" src="paste-circle.jpg">
      <img id="paste-rect" src="paste-rect.jpg">
      <img id="paste-triangle" src="paste-triangle.jpg">
      <img id="paste-heart" src="paste-heart.jpg">
      <img id="paste-heart2" src="paste-heart2.jpg">
      <img id="paste-heart3" src="paste-heart3.jpg">
      <img id="paste-hand" src="paste-hand.jpg">
      <img id="paste-star" src="paste-star.jpg">
      <img id="paste-imagine" src="paste-imagine.jpg">
    </div>
  
    <div class="container">
      <div class="pickr"></div>
      <canvas id="canvas"></canvas>
      <img id="test">
    </div>

     <!-- Modal Trigger -->
    <!--<a class="btn-floating btn-small waves-effect waves-light red modal-trigger" href="#modal1" id="font_type"><i class="material-icons">font_download</i></a>-->
  

    <!-- Modal Structure -->
    <div id="font_type" class="modal bottom-sheet">
      <div class="modal-content">
        <h5>Modal Header</h5>
        <div class="collection">
          <a id="Times New Roman" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">Times New Roman (Default)</span>
          </a>
          <a id="helvetica" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">helvetica</span>
          </a>
          <a id="Lacquer" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">Lacquer</span>
          </a>
          <a id="Squada One" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">Squada One</span>
          </a>
          <a id="Sriracha" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">Sriracha</span>
          </a>
          <a id="Roboto" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">Roboto</span>
          </a>
          <a id="Source Sans Pro" class="collection-item avatar modal-close">
            <img src="" class="circle">
            <span class="title">Source Sans Pro</span>
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Agree</a>
      </div>
    </div>

    
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!--JavaScript at end of body for optimized loading
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.2/fabric.js"></script>
    <script>
      const pickr = Pickr.create({
            el: '.pickr',
            theme: 'nano', // or 'monolith', or 'nano'
            position: 'right-end',

            swatches: [
                'rgba(244, 67, 54, 1)',
                'rgba(233, 30, 99, 0.95)',
                'rgba(156, 39, 176, 0.9)',
                'rgba(103, 58, 183, 0.85)',
                'rgba(63, 81, 181, 0.8)',
                'rgba(33, 150, 243, 0.75)',
                'rgba(3, 169, 244, 0.7)',
                'rgba(0, 188, 212, 0.7)',
                'rgba(0, 150, 136, 0.75)',
                'rgba(76, 175, 80, 0.8)',
                'rgba(139, 195, 74, 0.85)',
                'rgba(205, 220, 57, 0.9)',
                'rgba(255, 235, 59, 0.95)',
                'rgba(255, 193, 7, 1)'
            ],

            components: {

                // Main components
                preview: true,
                opacity: true,
                hue: true,

                // Input / output Options
                interaction: {
                    input: true,
                    clear: true,
                    save: true
                }
            }
        });
      const canvas = new fabric.Canvas('canvas',{
        height: 550,
        width: 550
      })
      canvas.filterBackend = new fabric.WebglFilterBackend()
      // 目前狀態
      //let state = canvas.toJSON()
      let state 
      // 儲存之前的步驟
      let undo = []
      // 儲存之後的步驟
      let redo = []

      function save() {
         // clear the redo stack
         redo = [];
         $('#redo').prop('disabled', true);
         // initial call won't have a state
         if (state) {
           undo.push(state);
           $('#undo').prop('disabled', false);
         }
         state = JSON.stringify(canvas);
         console.log(state);
       }

      function replay(playStack, saveStack, buttonsOn, buttonsOff) {
         saveStack.push(state);
         state = playStack.pop();
         var on = $(buttonsOn);
         var off = $(buttonsOff);
         // turn both buttons off for the moment to prevent rapid clicking
         on.prop('disabled', true);
         off.prop('disabled', true);
         canvas.clear();
         canvas.loadFromJSON(state, function() {
           canvas.renderAll();
           // now turn the buttons back on if applicable
           on.prop('disabled', false);
           if (playStack.length) {
             off.prop('disabled', false);
           }
         });
       }

      const imageUploader = document.getElementById('imageUploader')
      const file2 = document.getElementById('file2')
      const imgset = document.getElementById('imgset')
      const defaultImg = document.getElementById('defaultImg')
      const edit_text = document.getElementById('edit_text')
      const edit_effect = document.getElementById('edit_effect')
      const change_background = document.getElementById('change_background')
      const fbold = document.getElementById('font_bold')
      const fcolor = document.getElementById('font_color')
      const ftype = document.getElementById('font_type')
      const fitalic = document.getElementById('font_italic')
      const fdownload = document.getElementById('file_download')

      fdownload.addEventListener('click',function(){
        console.log(canvas.toDataURL())
        document.getElementById('test').setAttribute('src',canvas.toDataURL())
      })
    

      fbold.addEventListener('click',function(){
        if(canvas.getActiveObject().fontWeight == 'bold'){
          fbold.setAttribute("class","btn-floating btn-small waves-effect waves-light red")
          canvas.getActiveObject().set({fontWeight:''})
        }
        else{
          fbold.setAttribute("class","btn-floating btn-small waves-effect waves-light grey lighten-2")
          canvas.getActiveObject().set({fontWeight:'bold'})
        }
        canvas.renderAll()
      })

      ftype.addEventListener('click',function(e){
        if(e.target.id != 'Times New Roman'){
          console.log(e.target.id)
          canvas.getActiveObject().set({fontFamily:e.target.id})
          canvas.renderAll();
        }      
      })
      fitalic.addEventListener('click',function(){
        if(canvas.getActiveObject().fontStyle == 'italic'){
          fitalic.setAttribute("class","btn-floating btn-small waves-effect waves-light red")
          canvas.getActiveObject().set({fontStyle:''})
        }
        else{
          fitalic.setAttribute("class","btn-floating btn-small waves-effect waves-light grey lighten-2")
          canvas.getActiveObject().set({fontStyle:'italic'})
        }
        canvas.renderAll();
      })
      fcolor.addEventListener('click',function(){
        canvas.getActiveObject().set({fill:'#eeeeee'})
        canvas.renderAll();
      })

      const tempcolumn = document.getElementById('tempcolumn')
      tempcolumn.addEventListener('click',function(){
        canvas.setBackgroundImage(document.getElementById(event.target.id).getAttribute('src'), () => canvas.renderAll()) 
      })
      
      const temppaste = document.getElementById('temppaste') 
      temppaste.addEventListener('click',function(){
        let nowclick = event.target.id
        if(nowclick == "paste-circle"){   
          const circle = new fabric.Circle({
            radius: 50, // 必要屬性
            fill: '#eeeeee',
            top: 10,
            left: 0
          })
          canvas.add(circle)
          save()
        }
        else if (nowclick == "paste-rect") {
          const rect = new fabric.Rect({
            width: 50,
            height: 50,
            fill: '#eeeeee',
            top: 10,
            left: 0,
            
          })
          canvas.add(rect)
          save()
        }
        else if (nowclick == "paste-triangle") {
          const triangle = new fabric.Triangle({
            width: 50,
            height: 50,
            fill: '#eeeeee',
            top: 10,
            left: 0
          })
          canvas.add(triangle)
          save()
        }
        else{
          const imgEl = document.createElement('img')
          //imgEl.crossOrigin = "anonymous";
          imgEl.src = document.getElementById(nowclick).getAttribute('src')
          imgEl.onload = () => {
            const image = new fabric.Image(imgEl, {
              scaleX: 0.1, // 大小設置為原來的 0.1
              scaleY: 0.1, // 大小設置為原來的 0.1
              top: 160,
              angle: 15,
              left: 100,
              crossOrigin:'anonymous'
            })
            canvas.add(image)
            save()
          }
        }

      })

      function handleRemove(e) { 
        canvas.remove(canvas.getActiveObject()); 
      } 


      let movingImage
      let imgDragOffset = {
        offsetX: 0,
        offsetY: 0
      }

      function uploadFile (e) {
        file2.click()
      }

      function saveImg (e) {
        if( e.target.tagName.toLowerCase() === 'img' ){
          imgDragOffset.offsetX = e.clientX - e.target.offsetLeft
          imgDragOffset.offsetY = e.clientY - e.target.offsetTop
          movingImage = e.target
        }
      }

      function handleFile () {
        const fileReader = new FileReader();
        fileReader.readAsDataURL(this.files[0])
        fileReader.onload = (e) => {
          // 圖片 base64
          const dataURL = e.target.result
          const img = document.createElement('img')
          img.draggable = true
          img.src = dataURL
          img.click = saveImg
          imgset.appendChild(img)
        }
      }

      function dropImg (e) {
        const {offsetX, offsetY} = e.e
        const image = new fabric.Image(movingImage, {
          width: movingImage.naturalWidth,
          height: movingImage.naturalHeight,
          scaleX: 100 / movingImage.naturalWidth,
          scaleY: 100 / movingImage.naturalHeight,
          top: offsetY - imgDragOffset.offsetY,
          left: offsetX - imgDragOffset.offsetX
        })
        canvas.add(image)
        save()
      }

      //新增編輯文字
      function addtext(){
        const iText = new fabric.IText('雙擊我編輯');
        canvas.add(iText);
        save() 
      }

      //圖層往上
      function moveup(){
        this.selectedobj = canvas.getActiveObject();
        this.selectedobj.bringForward();
      }

      //圖層往下
      function movedown(){
        this.selectedobj = canvas.getActiveObject();
        this.selectedobj.sendBackwards();
      }

      //刪除物件
      function deleteobj(){
        this.selectedobj = canvas.getActiveObject();
        canvas.remove(this.selectedobj);
        canvas.renderAll();
      }

      function load () {
        alert('load canvas!')
        canvas.loadFromJSON(saveJSON)
      }

      function do_undo(){
        if(undo.length){
          alert('目前沒有動作可復原')
          return
        }
        let lastJSON = undo.pop()
        canvas.loadFromJSON(lastJSON)
        redo.push(state)
        state = lastJSON
      }

      function do_redo(){
        if(!redo.length){
          alert('目前沒有動作可復原')
          return
        }
        let lastJSON = redo.pop()
        canvas.loadFromJSON(lastJSON)
        undo.push(state)
        state = lastJSON
      }

      const move_up = document.getElementById("moveup");
      move_up.addEventListener('click',moveup);
      const move_down = document.getElementById("movedown");
      move_down.addEventListener('click',movedown);
      const delete_obj = document.getElementById("deleteobj");
      delete_obj.addEventListener('click',deleteobj);
      const undobtn = document.getElementById("undo")
      //undobtn.addEventListener('click', replay(undo,redo,'#redo',this))
      const redobtn = document.getElementById("redo")
      //redobtn.addEventListener('click', replay(redo,undo,'#undo',this))
      $('#undo').click(function() {
         replay(undo, redo, '#redo', this);
      });
      $('#redo').click(function() {
         replay(redo, undo, '#undo', this);
      })

      imageUploader.addEventListener('click', uploadFile, true)
      file2.addEventListener('change', handleFile)
      canvas.on('drop', dropImg)
      edit_text.addEventListener('click',addtext)
      // defaultImg.addEventListener('mousedown', saveImg)
      imgset.addEventListener('mousedown', saveImg)
      change_background.addEventListener('click',() => {
        tempcolumn.style.display='block';
      })
      edit_effect.addEventListener('click',() => {
        temppaste.style.display='block'
      })

      canvas.on('selection:updated',function(e){
        console.log(e.target.get('type'))
        if(e.target.get('type') == 'i-text'){
          if(canvas.getActiveObject().fontWeight == 'bold'){
            fbold.setAttribute("class","btn-floating btn-small waves-effect waves-light grey lighten-2")
          }
          else{
            fbold.setAttribute("class","btn-floating btn-small waves-effect waves-light red")
          }

          if(canvas.getActiveObject().fontStyle == 'italic'){
            fitalic.setAttribute("class","btn-floating btn-small waves-effect waves-light grey lighten-2")
          }
          else{
            fitalic.setAttribute("class","btn-floating btn-small waves-effect waves-light red")
          }

        }
        else{
          fbold.setAttribute("class","btn-floating btn-small waves-effect waves-light red")
          fitalic.setAttribute("class","btn-floating btn-small waves-effect waves-light red")
          console.log(e.target.get('type'))
        }

      })

      canvas.on('mouse:down', e => {
        //console.log(e);
        //const active = canvas.getActiveObject();
        //console.log(active)
        if(canvas.getActiveObject()){
          pickr.on('change',(color,instance)=>{
            console.log(color.toRGBA().toString());
            const rgbaColor = color.toRGBA().toString();
            if(canvas.getActiveObject().get('type') == 'image'){
              console.log(fabric.Image.filters);
              var filter = new fabric.Image.filters.BlendColor({
                color:rgbaColor,
                mode:'tint',
                opacity: 0.6,
                alpha: 1.0
              });
              canvas.getActiveObject().filters.push(filter);
              canvas.getActiveObject().applyFilters();
            }
            else{
              canvas.getActiveObject().set({fill:rgbaColor});
            }
            canvas.renderAll();
            
          })
          //active.set({fill:'yellow'})

        }
      })

      canvas.on('object:modified', e => {
        save()
      })


      /*
      const canvas = new fabric.Canvas('canvas',{
        height:500,
        width:750
      });
      const iText = new fabric.IText('雙擊我編輯', {
        //字型
        //fontFamily: 'helvetica',
        //底線
        //underline: true, 
        //陰影
        //shadow: 'rgba(0,0,0,0.7) 5px 5px 5px',
        //斜體
        //fontStyle: 'italic',
        //strokewidth 邊框粗細
        //strokeWidth: 2,
        //邊框顏色
        //stroke: blue,
        left: 0,
        top: 120
      })
      canvas.add(iText)

      //canvas.setBackgroundImage( , () => canvas.renderAll());
      const rect = new fabric.Rect({
        top: 10,
        left: 10,
        width: 30,
        height: 30
      });

      canvas.add(rect);

      const imgEl = document.createElement('img')
      imgEl.src = 'https://www.pakutaso.com/shared/img/thumb/AMEMAN17826009_TP_V.jpg'
      imgEl.onload = () => {
        const image = new fabric.Image(imgEl, {
          scaleX: 0.1, // 大小設置為原來的 0.1
          scaleY: 0.1, // 大小設置為原來的 0.1
          top: 160,
          angle: 15,
          left: 100
        })
        canvas.add(image)
      }
      */

    </script>

    
    <script src="./js/materialize.js"></script>
    <script src="./js/init.js"></script>
    <script>


      function send_daily(){
        document.getElementById('show').style.display="block";
        const topic = document.getElementById('topic').value;
        const date = document.getElementById('date').value;
        const content = document.getElementById('textarea1').value;
        const filelist = document.getElementById('file').files[0];
        document.getElementById('result').innerHTML = `
         <div class="row">
          <div class="col s12">
            <div class="card">
              <div class="card-image">
                <img id="demo">
                <span class="card-title">${topic}</span>
                <h5>${date}</h5>
                <a class="btn-floating halfway-fab waves-effect waves-light red"><i class="material-icons">add</i></a>
              </div>
              <div class="card-content">
                <p>${content}</p>
              </div>
            </div>
          </div>
        </div>
        `
        var reader = new FileReader();
        reader.onload = function(e){
          $('#demo').attr('src', e.target.result);
        }
        reader.readAsDataURL(filelist);
      }


      //讀image
      //ajax讀取頁面
      //照片拼貼
    </script>
   
  </body>
</html>
      